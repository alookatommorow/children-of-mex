document.addEventListener("turbolinks:load", function() {

  if (window.location.pathname === "/donations/new") {

    // configure stripe handler
    var handler = StripeCheckout.configure({
      key: '<%= ENV.fetch("STRIPE_PUBLIC") %>',
      image: 'https://s3-us-west-1.amazonaws.com/children-of-mexico/icon-padded.png',
      locale: 'auto',
      zipCode: true,
      billingAddress: true,
      token: function(token) {
        var data =  {
          stripe_token: token.id,
          donation: {
            amount_in_cents: parsedAmount,
            email: token.email
          }
        }
        $.post("/donations", data).done(function() {
          console.log("charge created");
        });
      }
    });

    // close handler on cancel button click to prevent multiple payment modals
    $(".cancel-donation").click(function() {
      handler.close();

      $(".confirmation").fadeOut(function() {
        $("input[name=amount]").val("");
        $(".amount-form").fadeIn();
      });
    });

    $(".amount-form").submit(function (event) {
      event.preventDefault();

      var validation = new FormValidator(this).validateForm();
      var amount = $("input[name=amount]").val()
      var parsedAmount = parseFloat(amount) * 100;

      if (validation) {
        $(".confirm-amount").text(amount);
        $(this).fadeOut(function() {
          $(".confirmation").fadeIn();
        });

        $("#donate-button").click(function(event) {
          event.preventDefault();
          // Open Checkout with further options:
          handler.open({
            name: 'Children of Mexico International',
            description: 'Donation',
            amount: parsedAmount
          });
        });
      }
    });

    // Close Checkout on page navigation:
    window.addEventListener('popstate', function() {
      handler.close();
    });
  }

});